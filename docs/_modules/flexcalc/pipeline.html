

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>flexcalc.pipeline &mdash; flexcalc  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> flexcalc
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">flexCALC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flexcalc.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">flexcalc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>flexcalc.pipeline</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for flexcalc.pipeline</h1><div class="highlight"><pre>
<span></span><span class="c1"># &gt;&gt;&gt; Imports &gt;&gt;&gt;</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>

<span class="c1">#from glob import glob        </span>

<span class="kn">from</span> <span class="nn">flexdata</span> <span class="k">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">dt</span>
<span class="kn">from</span> <span class="nn">flexdata</span> <span class="k">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">flexdata</span> <span class="k">import</span> <span class="n">display</span>

<span class="kn">from</span> <span class="nn">flextomo</span> <span class="k">import</span> <span class="n">projector</span>
<span class="kn">from</span> <span class="nn">flexcalc</span> <span class="k">import</span> <span class="n">process</span>
<span class="kn">from</span> <span class="nn">flexcalc</span> <span class="k">import</span> <span class="n">analyze</span>

<span class="kn">import</span> <span class="nn">networkx</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">flexdata.data</span> <span class="k">import</span> <span class="n">logger</span>

<span class="c1"># &gt;&gt;&gt; Classes &gt;&gt;&gt;</span>

<div class="viewcode-block" id="Buffer"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer">[docs]</a><span class="k">class</span> <span class="nc">Buffer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Each node has an input and output buffer. It will be in read-only or write-only state.</span>
<span class="sd">    Buffer can store a memmap data and a metadata record.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">writer_node</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Find an appropriate the directory:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        
        <span class="c1"># Don&#39;t assign a file before buffer is activated!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        
        <span class="c1"># Init data and geometry:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geom_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_misc_</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># Data attributes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span> <span class="o">=</span> <span class="kc">None</span>
                        
        <span class="c1"># Init links to the writer/reader nodes:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writer_node</span> <span class="o">=</span> <span class="n">writer_node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader_node</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1">#logger.print(writer_node.node_name + &#39; created a buffer!&#39;)</span>
        
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Attempt to copy a buffer!&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="kc">None</span>
        
    <span class="k">def</span> <span class="nf">_get_filename_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find an unused filename:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
        
        <span class="c1"># Create a dir if needed:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>    
        
        <span class="c1"># Get all files to add one at the end of the list:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">get_files_sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;scratch&#39;</span><span class="p">)</span>
      
        <span class="c1"># Get the new index:</span>
        <span class="k">if</span> <span class="n">files</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">9999</span><span class="p">)</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exist</span><span class="p">])</span>
            
        <span class="c1"># Add new file:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;scratch_</span><span class="si">%04u</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
        
<div class="viewcode-block" id="Buffer.switch_readonly"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.switch_readonly">[docs]</a>    <span class="k">def</span> <span class="nf">switch_readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Switch the buffer into reading mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get a new name if needed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename_</span><span class="p">()</span>
        
        <span class="c1"># Make sure that file was written on disk:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtype</span>  <span class="o">=</span> <span class="s1">&#39;float32&#39;</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
        <span class="c1"># Link with a file (array can be modified but the file stays read-only):</span>
        <span class="c1"># Previous option made a copy and ofter run out of memory. Now we use read-only.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span></div>
            
<div class="viewcode-block" id="Buffer.switch_writeonly"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.switch_writeonly">[docs]</a>    <span class="k">def</span> <span class="nf">switch_writeonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Switch the buffer into writing mode.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Get a new name if needed:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_get_filename_</span><span class="p">()</span>
      
      <span class="n">dshape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dshape</span>  
      <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>            
      
      <span class="c1"># Release memmap:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            
      <span class="c1"># Link with a file:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">dshape</span><span class="p">)</span>       
      <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span> <span class="o">=</span> <span class="kc">False</span></div>
      
<div class="viewcode-block" id="Buffer.switch_offline"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.switch_offline">[docs]</a>    <span class="k">def</span> <span class="nf">switch_offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Switch buffers to offline to be able to serialize node tree and save them on disk.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">shape</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="Buffer.switch_online"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.switch_online">[docs]</a>    <span class="k">def</span> <span class="nf">switch_online</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Switch buffers to online after loading the node tree from disk or after backing it up.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">:</span> <span class="k">return</span> 
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span><span class="p">)</span> 
            
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span><span class="p">)</span>             </div>
                
<div class="viewcode-block" id="Buffer.suicide"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.suicide">[docs]</a>    <span class="k">def</span> <span class="nf">suicide</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Remove file from disk and delete variables.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_geom_</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_misc_</span> <span class="o">=</span> <span class="kc">None</span>
      
      <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>     
          <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Deleted a memmap file @&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dshape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">shape</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
      
    <span class="nd">@dshape</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the shape of the buffered data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to write into read-only block!&#39;</span><span class="p">)</span>
        
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">shape</span>
            
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">dtype</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;float32&#39;</span>
        
    <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Change the type of the buffered data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to write into read-only block!&#39;</span><span class="p">)</span>
        
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shape</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">dtype</span>
    
<div class="viewcode-block" id="Buffer.set_data"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.set_data">[docs]</a>    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Write the data array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to write into read-only block!&#39;</span><span class="p">)</span>
                
        <span class="c1"># Check free space:</span>
        <span class="n">buffer_gb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span> 
        <span class="n">free_gb</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">free_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Writing buffer of </span><span class="si">%1.1f</span><span class="s1">GB (</span><span class="si">%u%%</span><span class="s1"> of current disk space).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">buffer_gb</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">buffer_gb</span> <span class="o">/</span> <span class="n">free_gb</span><span class="p">))</span>
        
        <span class="c1"># We will open data here again in case the shape or type changed:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">memmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;w+&#39;</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_dtype_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dshape_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">shape</span></div>
    
<div class="viewcode-block" id="Buffer.get_data"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.get_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the data array.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to read an empty buffer!&#39;</span><span class="p">)</span>
        
        <span class="c1"># Check free space:        </span>
        <span class="n">buffer_gb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span> 
        <span class="n">free_gb</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">free_memory</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>                
        <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Retrieving buffer of </span><span class="si">%1.1f</span><span class="s1">GB (</span><span class="si">%u%%</span><span class="s1"> of current RAM).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">buffer_gb</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">buffer_gb</span> <span class="o">/</span> <span class="n">free_gb</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_</span></div>
      
<div class="viewcode-block" id="Buffer.get_geom"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.get_geom">[docs]</a>    <span class="k">def</span> <span class="nf">get_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the meta record.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
           <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geom_</span><span class="p">)</span>
       
        <span class="k">else</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geom_</span></div>

<div class="viewcode-block" id="Buffer.set_geom"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.set_geom">[docs]</a>    <span class="k">def</span> <span class="nf">set_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Write the meta record.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to write into read-only block!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geom_</span> <span class="o">=</span> <span class="n">geom</span></div>

<div class="viewcode-block" id="Buffer.get_misc"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.get_misc">[docs]</a>    <span class="k">def</span> <span class="nf">get_misc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the meta record.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
           <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_misc_</span><span class="p">)</span>
       
        <span class="k">else</span><span class="p">:</span>
           <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_misc_</span></div>
            
<div class="viewcode-block" id="Buffer.set_misc"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Buffer.set_misc">[docs]</a>    <span class="k">def</span> <span class="nf">set_misc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">misc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Write the misc record.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to write into read-only block!&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_misc_</span> <span class="o">=</span> <span class="n">misc</span></div>
            
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># This can be a copy of an original buffer. Suicide only on request!</span>
        <span class="c1">#self.suicide()</span>
        <span class="k">pass</span></div>
      
<span class="c1"># States:</span>
<span class="n">_NSTATE_PENDING_</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_NSTATE_ACTIVE_</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">_NSTATE_DEACTIVATED_</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># Types of nodes:</span>
<span class="n">_NTYPE_BATCH_</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">_NTYPE_GROUP_</span> <span class="o">=</span> <span class="mi">1</span>
   
<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node">[docs]</a><span class="k">class</span> <span class="nc">Node</span><span class="p">:</span>
   <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">   Class responsible for processing of a single block of data.</span>
<span class="sd">   It has two buffers: input and output.</span>
<span class="sd">   Three states: waiting, active, ready</span>
<span class="sd">   Three methods: start, action, finish</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="c1"># Default node type:</span>
   <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
   <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Default node&#39;</span>
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scheduler</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Initialize ...</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Buffers:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>
      
      <span class="c1"># Parent:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">scheduler</span>
      
      <span class="c1"># Initial state and type:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_NSTATE_PENDING_</span>
       
      <span class="c1"># Arguments:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="n">arguments</span>
            
      <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Initializing node: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="p">)</span>
      
      <span class="c1"># Call the initialize method defined in the sub-class:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
      
<div class="viewcode-block" id="Node.state2str"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.state2str">[docs]</a>   <span class="k">def</span> <span class="nf">state2str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Report my state.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_PENDING_</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;PENDING&#39;</span>
       <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_ACTIVE_</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;ACTIVE&#39;</span>
       <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_DEACTIVATED_</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;DEACTIVATED&#39;</span>
       <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;UNKNOWN&#39;</span></div>
   
<div class="viewcode-block" id="Node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.initialize">[docs]</a>   <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Initializtion callback. Override this in sub-classes</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> </div>
    
<div class="viewcode-block" id="Node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.runtime">[docs]</a>   <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Runtime callback. Override this in sub-classes</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="c1"># Pass data from the input buffer to output without change:</span>
       <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
       
       <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span></div>
       
<div class="viewcode-block" id="Node.init_outputs"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.init_outputs">[docs]</a>   <span class="k">def</span> <span class="nf">init_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Create output buffers.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
          <span class="n">buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
          
          <span class="c1"># By default, buffer meta record is passed from parent to child:</span>
          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
              <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_geom</span><span class="p">()</span>
              <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_misc</span><span class="p">()</span>
              
              <span class="n">buffer</span><span class="o">.</span><span class="n">set_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
              <span class="n">buffer</span><span class="o">.</span><span class="n">set_misc</span><span class="p">(</span><span class="n">misc</span><span class="p">)</span>
              
          <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>   </div>
          
<div class="viewcode-block" id="Node.get_outputs"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.get_outputs">[docs]</a>   <span class="k">def</span> <span class="nf">get_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data, geom and misc from a buffer using index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_geom</span><span class="p">(),</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_misc</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="Node.get_inputs"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.get_inputs">[docs]</a>   <span class="k">def</span> <span class="nf">get_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data, geom and misc from a buffer using index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        
        <span class="c1"># We will make a copy of a read-only memmap buffer to allow some operations to perform computations on this variable.</span>
        <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_geom</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">buf</span><span class="o">.</span><span class="n">get_misc</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="Node.set_outputs"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.set_outputs">[docs]</a>   <span class="k">def</span> <span class="nf">set_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Set data, geom and misc from a buffer using index</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
           
       <span class="k">if</span> <span class="ow">not</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_geom</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
           
       <span class="k">if</span> <span class="ow">not</span> <span class="n">misc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
           <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">set_misc</span><span class="p">(</span><span class="n">misc</span><span class="p">)</span></div>
           
<div class="viewcode-block" id="Node.offline"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.offline">[docs]</a>   <span class="k">def</span> <span class="nf">offline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Switch node to offline (switch its buffers to offline). This is needed for backing up nodes.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">for</span> <span class="n">buf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
           <span class="n">buf</span><span class="o">.</span><span class="n">switch_offline</span><span class="p">()</span></div>
   
<div class="viewcode-block" id="Node.online"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.online">[docs]</a>   <span class="k">def</span> <span class="nf">online</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Switch node to online (switch its buffers to online). This is needed for backing up nodes.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">for</span> <span class="n">buf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
           <span class="n">buf</span><span class="o">.</span><span class="n">switch_online</span><span class="p">()</span>        </div>
        
<div class="viewcode-block" id="Node.get_parents"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.get_parents">[docs]</a>   <span class="k">def</span> <span class="nf">get_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get parent nodes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">writer_node</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">nodes</span> </div>

<div class="viewcode-block" id="Node.isready"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.isready">[docs]</a>   <span class="k">def</span> <span class="nf">isready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Check if the node is ready.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Check if parent nodes are deactivated:</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parents</span><span class="p">():</span>       
          <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">_NSTATE_DEACTIVATED_</span><span class="p">:</span>
              <span class="k">return</span> <span class="kc">False</span>
      
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">_NSTATE_PENDING_</span><span class="p">:</span>
              <span class="k">return</span> <span class="kc">False</span>
        
      <span class="k">return</span> <span class="kc">True</span></div>
                     
<div class="viewcode-block" id="Node.activate"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.activate">[docs]</a>   <span class="k">def</span> <span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Switch input buffers to read-only mode and output buffers to write-only.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Activating node: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_name</span><span class="p">)</span>
      
      <span class="c1"># Check if parent nodes are deactivated:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isready</span><span class="p">():</span>
              <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to activate a wrong node. Check node state and parent nodes states.&#39;</span><span class="p">)</span>
               
      <span class="c1"># Switch buffers to read/write:        </span>
      <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
         <span class="n">buffer</span><span class="o">.</span><span class="n">switch_readonly</span><span class="p">()</span>
      
      <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
         <span class="n">buffer</span><span class="o">.</span><span class="n">switch_writeonly</span><span class="p">()</span>
         
      <span class="c1"># Change state and run:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_NSTATE_ACTIVE_</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">()</span>
      
      <span class="c1"># If success, change state:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">deactivate</span><span class="p">()</span></div>
                              
<div class="viewcode-block" id="Node.deactivate"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.deactivate">[docs]</a>   <span class="k">def</span> <span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Kill all inputs. Switch all outputs to read-only mode.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Check if the node is in correct state:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">_NSTATE_ACTIVE_</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Attempt to deactivate node that is not on an active state!&#39;</span><span class="p">)</span>
        
      <span class="c1"># Clean up memory!  </span>
      <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>  
        
      <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_NSTATE_DEACTIVATED_</span>
      
      <span class="c1"># Check if the output buffer is</span>
      <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dshape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Node output buffer is too small!&#39;</span><span class="p">)</span>
      
      <span class="c1"># Switch states of the buffers:</span>
      <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
         <span class="n">buffer</span><span class="o">.</span><span class="n">switch_readonly</span><span class="p">()</span>
            
      <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
         <span class="n">buffer</span><span class="o">.</span><span class="n">suicide</span><span class="p">()</span></div>

<div class="viewcode-block" id="Node.get_children"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.get_children">[docs]</a>   <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Get children nodes.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        
       <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">!=</span> <span class="p">[]:</span> 
           <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
               <span class="n">node</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">reader_node</span>
               
               <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                   <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">_NTYPE_GROUP_</span><span class="p">:</span>
                       <span class="c1"># If nodes is a group node, all buffers end up in a single node:</span>
                       <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">,</span> <span class="p">]</span>
                   
                   <span class="k">else</span><span class="p">:</span>
                       <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
               
           <span class="k">return</span> <span class="n">nodes</span>
       
       <span class="k">else</span><span class="p">:</span>
           <span class="k">return</span> <span class="p">[]</span></div>
     
<div class="viewcode-block" id="Node.cleanup"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.Node.cleanup">[docs]</a>   <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">       Remove files:</span>
<span class="sd">       &#39;&#39;&#39;</span>
       <span class="c1"># Delete files:</span>
       <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
           <span class="n">buffer</span><span class="o">.</span><span class="n">suicide</span><span class="p">()</span>
           
       <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
           <span class="n">buffer</span><span class="o">.</span><span class="n">suicide</span><span class="p">()</span>      </div></div>
           
<span class="c1"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; Node classes &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;           </span>
       
<div class="viewcode-block" id="batch_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.batch_node">[docs]</a><span class="k">class</span> <span class="nc">batch_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard batch node based on a given callback function.</span>
<span class="sd">    Callback function is saved as the first argument in the argument list.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;batch&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="batch_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.batch_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">data</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1">#out = callback(data, geom, **args)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
            
            <span class="c1"># If there is output pass it further down the pipeline:</span>
            <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">data</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>    
            
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div></div>
        
<div class="viewcode-block" id="info_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.info_node">[docs]</a><span class="k">class</span> <span class="nc">info_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print data info.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Buffer Info&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="info_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.info_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%u</span><span class="s1"> buffers.&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Data shape: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Data range: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()]))</span>
      
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Geometry:&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>  
            
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div></div>
            
<div class="viewcode-block" id="fdk_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.fdk_node">[docs]</a><span class="k">class</span> <span class="nc">fdk_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Feldkamp reconstruction.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;FDK&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="fdk_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.fdk_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">vol_shape</span><span class="p">,</span> <span class="n">sirt</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="k">if</span> <span class="n">vol_shape</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vol_shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vol</span> <span class="o">=</span> <span class="n">projector</span><span class="o">.</span><span class="n">init_volume</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="n">projector</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">subsets</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">projector</span><span class="o">.</span><span class="n">FDK</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">sirt</span><span class="p">:</span>
            <span class="n">projector</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9999</span><span class="p">]</span>
            <span class="n">projector</span><span class="o">.</span><span class="n">SIRT</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">iterations</span> <span class="o">=</span> <span class="n">sirt</span><span class="p">)</span>    
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>                 </div></div>

<div class="viewcode-block" id="crop_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.crop_node">[docs]</a><span class="k">class</span> <span class="nc">crop_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply crop.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Crop&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="crop_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.crop_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
               
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> </div></div>
        
<div class="viewcode-block" id="bin_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.bin_node">[docs]</a><span class="k">class</span> <span class="nc">bin_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply binning.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Bin&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="bin_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.bin_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
               
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
  
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>         </div></div>

<div class="viewcode-block" id="pad_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.pad_node">[docs]</a><span class="k">class</span> <span class="nc">pad_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply autocrop.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Pad&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="pad_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.pad_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">geom</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>              </div></div>

<div class="viewcode-block" id="beamhardening_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.beamhardening_node">[docs]</a><span class="k">class</span> <span class="nc">beamhardening_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply beam hardening based on a single material approximation and an estimated spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Beam-hardening correction&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="beamhardening_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.beamhardening_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
                
        <span class="c1"># Use toml files:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_toml</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;File not found:&#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">equivalent_density</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;spectrum&#39;</span><span class="p">],</span> <span class="n">compound</span> <span class="o">=</span> <span class="n">compound</span><span class="p">,</span> <span class="n">density</span> <span class="o">=</span> <span class="n">density</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>    </div></div>

<div class="viewcode-block" id="display_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.display_node">[docs]</a><span class="k">class</span> <span class="nc">display_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display data.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Display&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="display_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.display_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="n">display_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># Find callback:        </span>
        <span class="n">dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;slice&#39;</span><span class="p">:</span> <span class="n">display</span><span class="o">.</span><span class="n">slice</span><span class="p">,</span> <span class="s1">&#39;max_projection&#39;</span><span class="p">:</span> <span class="n">display</span><span class="o">.</span><span class="n">max_projection</span><span class="p">,</span><span class="s1">&#39;min_projection&#39;</span><span class="p">:</span><span class="n">display</span><span class="o">.</span><span class="n">min_projection</span><span class="p">,</span><span class="s1">&#39;pyqt_graph&#39;</span><span class="p">:</span><span class="n">display</span><span class="o">.</span><span class="n">pyqt_graph</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="n">display_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown display type!&#39;</span><span class="p">)</span>
            
        <span class="n">callback</span> <span class="o">=</span> <span class="n">dictionary</span><span class="p">[</span><span class="n">display_type</span><span class="p">]</span>        
        
        <span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>           </div></div>

<div class="viewcode-block" id="autocrop_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.autocrop_node">[docs]</a><span class="k">class</span> <span class="nc">autocrop_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply autocrop.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Autocrop&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="autocrop_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.autocrop_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        
        <span class="n">data</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">autocrop</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>              </div></div>

<div class="viewcode-block" id="markernorm_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.markernorm_node">[docs]</a><span class="k">class</span> <span class="nc">markernorm_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find marker and normalize data using its intensity.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Marker normalization&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="markernorm_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.markernorm_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
         
        <span class="n">norm</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>               
        
        <span class="c1"># Find the marker:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="n">analyze</span><span class="o">.</span><span class="n">find_marker</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>    
        
        <span class="n">rho</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    
        <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Marker density is: </span><span class="si">%2.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rho</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rho</span> <span class="o">-</span> <span class="n">norm</span><span class="p">)</span> <span class="o">/</span> <span class="n">rho</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Suspicious marker density: </span><span class="si">%0.2f</span><span class="s1">. Will not apply correction!&#39;</span> <span class="o">%</span> <span class="n">rho</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">*=</span> <span class="p">(</span><span class="n">norm</span> <span class="o">/</span> <span class="n">rho</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> </div></div>
        
<div class="viewcode-block" id="threshold_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.threshold_node">[docs]</a><span class="k">class</span> <span class="nc">threshold_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a soft threshold.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Soft threshold&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="threshold_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.threshold_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="n">process</span><span class="o">.</span><span class="n">soft_threshold</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>                     </div></div>
        
<div class="viewcode-block" id="cast2type_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.cast2type_node">[docs]</a><span class="k">class</span> <span class="nc">cast2type_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply autocrop.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Cast to type&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="cast2type_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.cast2type_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Casting data to &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dtype</span><span class="p">))</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">cast2type</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>  </div></div>
        
<div class="viewcode-block" id="flatlog_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.flatlog_node">[docs]</a><span class="k">class</span> <span class="nc">flatlog_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply flat-field and dark-field correction. Take -log(x).</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Flatlog&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                  
<div class="viewcode-block" id="flatlog_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.flatlog_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">usemax</span><span class="p">,</span> <span class="n">flats</span><span class="p">,</span> <span class="n">darks</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="k">if</span> <span class="n">usemax</span><span class="p">:</span>
            <span class="c1"># Use data-driven flat field correction:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">flatfield</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">path</span> <span class="o">=</span> <span class="n">misc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Path to data not found in the metadata.&#39;</span><span class="p">)</span>
            
            <span class="c1"># Read darks and flats:</span>
            <span class="k">if</span> <span class="n">darks</span><span class="p">:</span>
                <span class="n">dark</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_stack</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">darks</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">transpose</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span> <span class="o">=</span> <span class="n">updown</span><span class="p">)</span>
                    
                <span class="k">if</span> <span class="n">dark</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">dark</span> <span class="o">=</span> <span class="n">dark</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    
                <span class="n">data</span> <span class="o">-=</span> <span class="n">dark</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dark</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="k">if</span> <span class="n">flats</span><span class="p">:</span>    
                <span class="n">flat</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_stack</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">flats</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="n">transpose</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span> <span class="o">=</span> <span class="n">updown</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">flat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">flat</span> <span class="o">=</span> <span class="n">flat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                
                    <span class="n">data</span> <span class="o">/=</span> <span class="p">(</span><span class="n">flat</span> <span class="o">-</span> <span class="n">dark</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
            
        <span class="n">numpy</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">data</span><span class="p">)</span>    
        <span class="n">data</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                
        <span class="c1"># Fix nans and infs after log:</span>
        <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">10</span>        
        
        <span class="c1"># TODO: make sure that all functions return data!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>         </div></div>
      
<div class="viewcode-block" id="vol_merge_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.vol_merge_node">[docs]</a><span class="k">class</span> <span class="nc">vol_merge_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge volumes node.</span>
<span class="sd">    &quot;&quot;&quot;</span>     
    
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Merge volumes&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_GROUP_</span>
    
<div class="viewcode-block" id="vol_merge_node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.vol_merge_node.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>
                                
<div class="viewcode-block" id="vol_merge_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.vol_merge_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Determine Total Bounds:</span>
        <span class="n">tot_bounds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                
        <span class="c1"># Find bounds of the volumes:</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
            
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
    
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">volume_bounds</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            
            <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_geom</span><span class="p">()</span>
        
        <span class="n">tot_geom</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        <span class="n">tot_geom</span><span class="p">[</span><span class="s1">&#39;vol_tra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="n">tot_bounds</span> <span class="o">=</span> <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">tot_bounds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">tot_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tot_bounds</span> <span class="o">/</span> <span class="n">tot_geom</span><span class="p">[</span><span class="s1">&#39;img_pixel&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># Update buffer shape and get a link to it:        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dshape</span> <span class="o">=</span> <span class="n">tot_shape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_geom</span><span class="p">(</span><span class="n">tot_geom</span><span class="p">)</span>
        
        <span class="n">tot_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        
        <span class="c1"># Append volumes:    </span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
            
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">append_volume</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">tot_data</span><span class="p">,</span> <span class="n">tot_geom</span><span class="p">,</span> <span class="n">ramp</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span></div></div>
         
<div class="viewcode-block" id="derotate_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.derotate_node">[docs]</a><span class="k">class</span> <span class="nc">derotate_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derotate projections by geom[&#39;det_roll&#39;].</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Derotate projections&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                    
<div class="viewcode-block" id="derotate_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.derotate_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
        <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="k">if</span> <span class="n">angle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">angle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Derotating the detector image!&#39;</span><span class="p">)</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">process</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> </div></div>
        
<div class="viewcode-block" id="proj_merge_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.proj_merge_node">[docs]</a><span class="k">class</span> <span class="nc">proj_merge_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge projections node.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Merge projections&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_GROUP_</span>
    
<div class="viewcode-block" id="proj_merge_node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.proj_merge_node.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The assumption is that all datasets are of the same size and resolution!</span>
        
        <span class="c1"># List of geometries and unique source positions:</span>
        <span class="n">geoms_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># First, we need to check how many unique source positions there are.</span>
        <span class="c1"># Create a separate sub-group of geometries for each source position.</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
            
            <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_geom</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">geom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;geometry record not found!&#39;</span><span class="p">)</span>
            
            <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">],</span> <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_tan&#39;</span><span class="p">]]</span>
            
            <span class="k">if</span> <span class="n">src_list</span> <span class="ow">is</span> <span class="p">[]:</span>
                <span class="n">src_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="n">geoms_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">geom</span><span class="p">,])</span>
                
            <span class="k">elif</span> <span class="n">src</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">src_list</span><span class="p">:</span>
                <span class="n">src_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                <span class="n">geoms_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">geom</span><span class="p">,])</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">src_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>    
                <span class="n">geoms_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geom</span><span class="p">)</span>
        
        <span class="c1"># Save geoms_list for runtime:        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_geoms_list_</span> <span class="o">=</span> <span class="n">geoms_list</span>
            
        <span class="c1"># Number of outputs = number of unique source positions:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geoms_list_</span><span class="p">))</span></div>
                
<div class="viewcode-block" id="proj_merge_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.proj_merge_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>        
        
        <span class="c1"># Compute a total geometry for each source position:</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">geoms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_geoms_list_</span><span class="p">):</span>
            
            <span class="c1"># Total geometry and shape for a single unique source position:</span>
            <span class="n">tot_shape</span><span class="p">,</span> <span class="n">tot_geom</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">tiles_shape</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">geoms</span><span class="p">)</span>
                    
            <span class="c1"># Create outputs:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">dshape</span> <span class="o">=</span> <span class="n">tot_shape</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">set_geom</span><span class="p">(</span><span class="n">tot_geom</span><span class="p">)</span>
            
        <span class="c1"># Retrieve a list of unique sources:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)):</span>
            
            <span class="n">geom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_geom</span><span class="p">()</span>
            <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">],</span> <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_tan&#39;</span><span class="p">]])</span>

        <span class="c1"># Add tiles one by one:            </span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>

            <span class="c1"># Find a unique source position:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            
            <span class="n">src</span> <span class="o">=</span> <span class="p">[</span><span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_ort&#39;</span><span class="p">],</span> <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;src_tan&#39;</span><span class="p">]]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
            
            <span class="c1"># Get the corresponding output</span>
            <span class="n">tot_data</span><span class="p">,</span> <span class="n">tot_geom</span><span class="p">,</span> <span class="n">tot_misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            
            <span class="c1"># Derotate tile if needed:</span>
            <span class="k">if</span> <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Derotating the detector image!&#39;</span><span class="p">)</span>
                <span class="n">angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">geom</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">])</span>
                <span class="n">process</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">geom</span><span class="p">[</span><span class="s1">&#39;det_roll&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="c1"># Append tile:    </span>
            <span class="n">process</span><span class="o">.</span><span class="n">append_tile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">tot_data</span><span class="p">,</span> <span class="n">tot_geom</span><span class="p">)</span></div></div>
                                
<div class="viewcode-block" id="optimize_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.optimize_node">[docs]</a><span class="k">class</span> <span class="nc">optimize_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use auto-focusing to optimize geometry parameters. Its a group node - it will wait untill all previous nodes are ready before activating.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Optimize&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_GROUP_</span>
    
<div class="viewcode-block" id="optimize_node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.optimize_node.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Initialize as many outputs as there are inputs:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span></div>
            
<div class="viewcode-block" id="optimize_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.optimize_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tile_index</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="c1"># Either optimize based on one tile or run all of them.</span>
        <span class="k">if</span> <span class="n">tile_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
        
                <span class="c1"># Read data form a single buffer:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            
                <span class="n">process</span><span class="o">.</span><span class="n">optimize_modifier</span><span class="p">(</span><span class="n">values</span> <span class="o">+</span> <span class="n">geom</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">samp</span> <span class="o">=</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">)</span>
            
                <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> 
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Read data form a single buffer:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">tile_index</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">optimize_modifier</span><span class="p">(</span><span class="n">values</span> <span class="o">+</span> <span class="n">geom</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">samp</span> <span class="o">=</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span> <span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="n">geom</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> 
                <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div></div>
            
<div class="viewcode-block" id="registration_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.registration_node">[docs]</a><span class="k">class</span> <span class="nc">registration_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Register volumes.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Registration&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_GROUP_</span>
    
<div class="viewcode-block" id="registration_node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.registration_node.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Initialize as many outputs as there are inputs:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">))</span></div>
            
<div class="viewcode-block" id="registration_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.registration_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="p">(</span><span class="n">subsamp</span><span class="p">,</span> <span class="n">use_moments</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        
        <span class="c1"># Either optimize based on one tile or run all of them.</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)):</span>
        
            <span class="c1"># Read data form a single buffer:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">ii</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="n">R</span><span class="p">,</span> <span class="n">T</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">register_volumes</span><span class="p">(</span><span class="n">data0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">subsamp</span> <span class="o">=</span> <span class="n">subsamp</span><span class="p">,</span> <span class="n">use_moments</span> <span class="o">=</span> <span class="n">use_moments</span><span class="p">,</span> <span class="n">use_CG</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
                
                <span class="n">display</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;DIFF PRE&#39;</span><span class="p">)</span>
                
                <span class="n">data</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">affine</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
                
                <span class="n">display</span><span class="o">.</span><span class="n">projection</span><span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">data0</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;DIFF POST&#39;</span><span class="p">)</span>
                
                <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div></div>
  
<div class="viewcode-block" id="writer_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.writer_node">[docs]</a><span class="k">class</span> <span class="nc">writer_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write data on disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>      
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Writer&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
                   
<div class="viewcode-block" id="writer_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.writer_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Read data form a single buffer:</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">compress</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
            
        <span class="n">path</span> <span class="o">=</span> <span class="n">misc</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing data at:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">write_stack</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="p">),</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span><span class="p">,</span> <span class="nb">zip</span> <span class="o">=</span> <span class="n">compress</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing meta to:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;geometry.toml&#39;</span><span class="p">))</span>
        <span class="n">dt</span><span class="o">.</span><span class="n">write_toml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="s1">&#39;geometry.toml&#39;</span><span class="p">),</span> <span class="n">geom</span><span class="p">)</span>  

        <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span>  </div></div>
        
<div class="viewcode-block" id="reader_node"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.reader_node">[docs]</a><span class="k">class</span> <span class="nc">reader_node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    
    <span class="n">node_name</span> <span class="o">=</span> <span class="s1">&#39;Reader&#39;</span>
    <span class="n">node_type</span> <span class="o">=</span> <span class="n">_NTYPE_BATCH_</span>
    
<div class="viewcode-block" id="reader_node.initialize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.reader_node.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initiallization callback of read_data. </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Get arguments:</span>
        <span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span><span class="p">,</span> <span class="n">proj_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">get_folders_sorted</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
       
        <span class="c1"># Create as many output buffers as there are paths:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_outputs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
          
            <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Found data @ &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
            
            <span class="c1">#shape = dt.stack_shape(path, name, sampling, sampling, shape, dtype, format, transpose, updown)</span>
            
            <span class="c1"># If present, read meta:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;metadata.toml&#39;</span><span class="p">)):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_flexraymeta</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>   
                
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;scan settings.txt&#39;</span><span class="p">)):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_flexraylog</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>  
                
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;meta.toml&#39;</span><span class="p">)):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_metatoml</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>  
            
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;geometry.toml&#39;</span><span class="p">)):</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_geometry</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">sampling</span><span class="p">)</span>  

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No meta data found.&#39;</span><span class="p">)</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="kc">None</span>
                
            <span class="c1"># Remember the path to the data using meta:    </span>
            <span class="n">misc</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;path&#39;</span><span class="p">:</span><span class="n">path</span><span class="p">}</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">misc</span><span class="p">)</span></div>
                        
<div class="viewcode-block" id="reader_node.runtime"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.reader_node.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get arguments:</span>
        <span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span><span class="p">,</span> <span class="n">proj_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">get_folders_sorted</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
           
        <span class="c1"># Read!</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
       
          <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Reading data @ &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
          <span class="n">array</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">read_stack</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="nb">format</span><span class="p">,</span> <span class="n">transpose</span><span class="o">=</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span> <span class="o">=</span> <span class="n">updown</span><span class="p">)</span>
          <span class="c1">#proj, meta = process.process_flex(path, sampling, sampling, proj_number = proj_number) </span>
            
          <span class="bp">self</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
          <span class="n">array</span> <span class="o">=</span> <span class="kc">None</span>
          <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span></div></div>
   
<span class="c1"># &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; SCHEDULER CLASS &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
          
<div class="viewcode-block" id="scheduler"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler">[docs]</a><span class="k">class</span> <span class="nc">scheduler</span><span class="p">:</span>
   <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">   Class responsible for scheduling tasks by creating tree of processing nodes connected via buffers.</span>
<span class="sd">   Scheduler links to the root_node that provides an entry point to the node tree.</span>
<span class="sd">   </span>
<span class="sd">   &#39;&#39;&#39;</span> 
   
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_scratch_path_</span><span class="p">,</span> <span class="n">clean_scratch</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
   
      <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="kc">None</span>      
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_scratch_path_</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Scratch path is missing!&#39;</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span> <span class="o">=</span> <span class="n">_scratch_path_</span>
      
      <span class="k">if</span> <span class="n">clean_scratch</span><span class="p">:</span>            
          <span class="bp">self</span><span class="o">.</span><span class="n">_clean_scratch_dir_</span><span class="p">()</span>
          
<div class="viewcode-block" id="scheduler.draw_nodes"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.draw_nodes">[docs]</a>   <span class="k">def</span> <span class="nf">draw_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Draw the node tree.</span>
<span class="sd">       &quot;&quot;&quot;</span>
        
       <span class="n">G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodesgraph_</span><span class="p">()</span>
       
       <span class="c1"># Compute nodes positions:</span>
       <span class="n">pos</span><span class="o">=</span><span class="n">networkx</span><span class="o">.</span><span class="n">drawing</span><span class="o">.</span><span class="n">nx_agraph</span><span class="o">.</span><span class="n">graphviz_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">prog</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">)</span>
           
       <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span> 
       <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Node Tree&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
       
       <span class="c1"># Draw edges:</span>
       <span class="n">edge_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
       
       <span class="n">networkx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_color</span> <span class="o">=</span> <span class="n">edge_color</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">node_size</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
              
       <span class="c1"># Draw nodes:       </span>
       <span class="n">node_color</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;fillcolor&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
       
       <span class="n">networkx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_color</span> <span class="o">=</span> <span class="n">node_color</span><span class="p">,</span> <span class="n">node_size</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
       <span class="n">networkx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_size</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">font_size</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">font_weight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
       
       <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
       <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
               
   <span class="k">def</span> <span class="nf">_clean_scratch_dir_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Remove all scratch files in a directory.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">):</span>
            
        <span class="c1"># Find old scratch files:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">file_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_</span><span class="p">):</span> 
                
                <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Removing scratch file @ &#39;</span> <span class="o">+</span> <span class="n">file_</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>
   
   <span class="k">def</span> <span class="nf">_free_buffers_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Get buffers that are at the end of the node tree.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Get nodes at the bottom of the tree:   </span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_free_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
      
      <span class="c1"># Get the buffers at the bottom:</span>
      <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
         <span class="n">buffers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span>
         
      <span class="k">return</span> <span class="n">buffers</span> 
  
   <span class="k">def</span> <span class="nf">_get_free_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Recursively go down the node tree and return the nodes at the bottom.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="c1"># Nodes below the current one:</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
      
      <span class="k">if</span> <span class="n">nodes</span> <span class="o">==</span> <span class="p">[]:</span>
         <span class="k">return</span> <span class="p">[</span><span class="n">node</span><span class="p">,]</span>
         
      <span class="k">else</span><span class="p">:</span>
         <span class="n">subnodes</span> <span class="o">=</span> <span class="p">[]</span>
         
         <span class="k">for</span> <span class="n">node_</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">free_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_free_nodes_</span><span class="p">(</span><span class="n">node_</span><span class="p">)</span>
            
            <span class="c1"># Check uniqness:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">free_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subnodes</span><span class="p">:</span> 
                    <span class="n">subnodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            
         <span class="k">return</span> <span class="n">subnodes</span>
  
   <span class="k">def</span> <span class="nf">_count_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Count how many nodes of a particular state there are.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
      
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">:</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
      
      <span class="k">return</span> <span class="n">count</span>
  
   <span class="k">def</span> <span class="nf">_state2color_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Small routine converting states to colors for drawing the node tree.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_PENDING_</span><span class="p">:</span>
           <span class="k">return</span> <span class="s1">&#39;red&#39;</span>
       
       <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_ACTIVE_</span><span class="p">:</span>
           <span class="k">return</span> <span class="s1">&#39;yellow&#39;</span>
       
       <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_DEACTIVATED_</span><span class="p">:</span>
           <span class="k">return</span> <span class="s1">&#39;green&#39;</span>
       
   <span class="k">def</span> <span class="nf">_get_nodesgraph_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Returns networkx.MultiDiGraph object for the given node.</span>
<span class="sd">      &quot;&quot;&quot;</span> 
      <span class="c1"># Directional multi-graph:</span>
      <span class="n">G</span> <span class="o">=</span> <span class="n">networkx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
      
      <span class="n">level_no</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">paren_level</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,]</span>
      
      <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[</span><span class="si">%u</span><span class="s1">.</span><span class="si">%u</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="o">.</span><span class="n">node_name</span>
      <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fillcolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state2color_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>      
      
      <span class="c1">#G.add_node(old_name)</span>
      
      <span class="k">while</span> <span class="n">paren_level</span><span class="p">:</span>
                    
          <span class="c1"># Loop over nodes in old level:</span>
          <span class="n">sub_no</span> <span class="o">=</span> <span class="mi">0</span>
          <span class="n">level</span> <span class="o">=</span> <span class="p">[]</span>
          <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paren_level</span><span class="p">):</span>
              
              <span class="n">parent_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[</span><span class="si">%u</span><span class="s1">.</span><span class="si">%u</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">level_no</span><span class="p">,</span> <span class="n">ii</span><span class="p">))</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">node_name</span>
              
              <span class="c1"># Make a new level making sure every node is unique:</span>
              <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
              
              <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                  
                  <span class="c1"># Add a unique link:</span>
                  <span class="k">if</span> <span class="n">child</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
                      <span class="n">level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                      <span class="n">sub_no</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                  <span class="n">child_name</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;[</span><span class="si">%u</span><span class="s1">.</span><span class="si">%u</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">level_no</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sub_no</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">child</span><span class="o">.</span><span class="n">node_name</span>    
                  
                  <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">child_name</span><span class="p">,</span> <span class="n">fillcolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state2color_</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
                  <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">parent_name</span><span class="p">,</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state2color_</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
                  
          <span class="n">paren_level</span> <span class="o">=</span> <span class="n">level</span>   
          <span class="n">level_no</span> <span class="o">+=</span> <span class="mi">1</span>    
              
      <span class="k">return</span> <span class="n">G</span>
  
   <span class="k">def</span> <span class="nf">_get_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Returns nodes with the given status.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">state</span><span class="p">):</span>
          <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">,]</span>
          
      <span class="k">else</span><span class="p">:</span>
          <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
      
      <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
      
      <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
          
          <span class="c1"># get descendent nodes but only unique ones:</span>
          <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
          
          <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span> 
                  <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                     
      <span class="k">return</span> <span class="n">out</span>
  
   <span class="k">def</span> <span class="nf">_get_nodeready_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Returns a single node that is ready for activation.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">return</span> <span class="kc">None</span>
      
      <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_PENDING_</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">isready</span><span class="p">():</span>
              <span class="k">return</span> <span class="n">node</span>
          
          <span class="k">else</span><span class="p">:</span>  
              <span class="c1"># Node may be PENDING but waiting for a group output - in that case need to switch to another branch.</span>
              <span class="k">return</span> <span class="kc">None</span>

      <span class="c1"># Return which ever is ready node:          </span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>      
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          
          <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeready_</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
          
          <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="k">return</span> <span class="n">out</span>
          
      <span class="k">return</span> <span class="kc">None</span>      
                    
<div class="viewcode-block" id="scheduler.backup"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.backup">[docs]</a>   <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Save the node tree on disk.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Backing up the tree of nodes.&#39;</span><span class="p">)</span>
      
      <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
      
      <span class="c1"># Count pending nodes:</span>
      <span class="n">pend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_nodes_</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">_NSTATE_PENDING_</span><span class="p">)</span>
      <span class="n">deactive</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_nodes_</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">_NSTATE_DEACTIVATED_</span><span class="p">)</span>
      <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_nodes_</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">_NSTATE_ACTIVE_</span><span class="p">)</span>
     
      <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%u</span><span class="s1"> pending | </span><span class="si">%u</span><span class="s1"> active | </span><span class="si">%u</span><span class="s1"> deactivated&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pend</span><span class="p">,</span> <span class="n">active</span><span class="p">,</span> <span class="n">deactive</span><span class="p">))</span>
      
      <span class="c1"># Switch nodes to offline:</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="n">node</span><span class="o">.</span><span class="n">offline</span><span class="p">()</span>
      
      <span class="c1"># Serialize using pickle:  </span>
      <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">,</span> <span class="s1">&#39;nodes.pickle&#39;</span><span class="p">)</span>
      <span class="n">pickle_out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">pickle_out</span><span class="p">)</span>
      <span class="n">pickle_out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      
      <span class="c1"># Put nodes back online:</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="n">node</span><span class="o">.</span><span class="n">online</span><span class="p">()</span></div>
      
<div class="viewcode-block" id="scheduler.restore_nodes"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.restore_nodes">[docs]</a>   <span class="k">def</span> <span class="nf">restore_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Load the node tree from disk.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;Loading nodes tree.&#39;</span><span class="p">)</span>
      
      <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scratch_path_</span><span class="p">,</span> <span class="s1">&#39;nodes.pickle&#39;</span><span class="p">)</span>
      
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Backup file cannot be found!&#39;</span><span class="p">)</span>
      
      <span class="n">pickle_in</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">)</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_in</span><span class="p">)</span>        
      
      <span class="c1"># Get nodes to online state (link to memmaps):</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="n">node</span><span class="o">.</span><span class="n">online</span><span class="p">()</span>
          
          <span class="c1"># Clear outputbuffers, in case there is some garbage:</span>
          <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_NSTATE_ACTIVE_</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">)):</span>
                  <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
                  <span class="n">data</span> <span class="o">*=</span> <span class="mi">0</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>
              
<div class="viewcode-block" id="scheduler.schedule"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.schedule">[docs]</a>   <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_class</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule nodes. </span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="c1"># Create the first node if needed:</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="n">node_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="p">[])</span>
         
      <span class="k">else</span><span class="p">:</span>
         <span class="c1"># Get free buffers: </span>
         <span class="n">buffers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_free_buffers_</span><span class="p">()</span>
      
         <span class="c1"># Create one node per buffer or one node for all buffers:</span>
         <span class="k">if</span> <span class="n">node_class</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">_NTYPE_BATCH_</span><span class="p">:</span>
         
            <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">:</span>
               <span class="c1"># Create an instance of a node:</span>
               <span class="n">buffer</span><span class="o">.</span><span class="n">reader_node</span> <span class="o">=</span> <span class="n">node_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="p">[</span><span class="n">buffer</span><span class="p">,])</span>
               
         <span class="k">elif</span> <span class="n">node_class</span><span class="o">.</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">_NTYPE_GROUP_</span><span class="p">:</span>   
             
            <span class="n">node</span> <span class="o">=</span> <span class="n">node_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">buffers</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="n">buffers</span><span class="p">:</span>
                <span class="c1"># Link all buffers with the same node:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">reader_node</span> <span class="o">=</span> <span class="n">node</span>
            
         <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown node type:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node_class</span><span class="o">.</span><span class="n">node_type</span><span class="p">))</span></div>
   
<div class="viewcode-block" id="scheduler.generic"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.generic">[docs]</a>   <span class="k">def</span> <span class="nf">generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">**</span><span class="n">arguments</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Schedule a generic batch node with one input and one output using any given callback function.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="c1"># Pass the callback as the first argument for batch_node:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">batch_node</span><span class="p">,</span> <span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">arguments</span><span class="p">))</span></div>

<div class="viewcode-block" id="scheduler.FDK"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.FDK">[docs]</a>   <span class="k">def</span> <span class="nf">FDK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vol_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sirt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Schedule FDK reconstruction.</span>
<span class="sd">       </span>
<span class="sd">       Args:</span>
<span class="sd">           vol_shape : force reconstruction volume shape</span>
<span class="sd">           sirt      : run a few iterations of SIRT with non-negativity constraint</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">vol_shape</span><span class="p">,</span> <span class="n">sirt</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">fdk_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>   </div>

<div class="viewcode-block" id="scheduler.soft_threshold"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.soft_threshold">[docs]</a>   <span class="k">def</span> <span class="nf">soft_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Removes values smaller than the threshold value.</span>
<span class="sd">      </span>
<span class="sd">      Args:</span>
<span class="sd">        mode (str)       : &#39;histogram&#39;, &#39;otsu&#39; or &#39;constant&#39;</span>
<span class="sd">        threshold (float): threshold value if mode = &#39;constant&#39;</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">threshold_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>   </div>
      
<div class="viewcode-block" id="scheduler.beamhardening"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.beamhardening">[docs]</a>   <span class="k">def</span> <span class="nf">beamhardening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">density</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Single material beamhardening based on a file with an effective spectrum record.</span>
<span class="sd">        Args:            </span>
<span class="sd">            file    : filepath of the spectrum record</span>
<span class="sd">            compound: chemical formula of the specimen material</span>
<span class="sd">            density : density in g / cm3</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">compound</span><span class="p">,</span> <span class="n">density</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">beamhardening_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>  </div>
      
<div class="viewcode-block" id="scheduler.markernorm"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.markernorm">[docs]</a>   <span class="k">def</span> <span class="nf">markernorm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Find a marker and normalize density of that marker to match the given value</span>
<span class="sd">        Args:            </span>
<span class="sd">            norm : value used for normalization</span>
<span class="sd">            size : size of the marker (diametre in mm)</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">markernorm_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>   </div>
      
<div class="viewcode-block" id="scheduler.pad"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.pad">[docs]</a>   <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule padding operation.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">pad_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span> </div>

<div class="viewcode-block" id="scheduler.bin"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.bin">[docs]</a>   <span class="k">def</span> <span class="nf">bin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule a bin operation.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">bin_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span> </div>
      
<div class="viewcode-block" id="scheduler.crop"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.crop">[docs]</a>   <span class="k">def</span> <span class="nf">crop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule a crop operation.           </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">crop_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>  </div>
      
<div class="viewcode-block" id="scheduler.autocrop"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.autocrop">[docs]</a>   <span class="k">def</span> <span class="nf">autocrop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule autocrop operation.            </span>
<span class="sd">      &quot;&quot;&quot;</span>      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">autocrop_node</span><span class="p">)</span>   </div>


<div class="viewcode-block" id="scheduler.cast2type"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.cast2type">[docs]</a>   <span class="k">def</span> <span class="nf">cast2type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">bounds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule a cast to type operation. </span>
<span class="sd">        Args:            </span>
<span class="sd">            </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">cast2type_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>   </div>

<div class="viewcode-block" id="scheduler.buffer_info"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.buffer_info">[docs]</a>   <span class="k">def</span> <span class="nf">buffer_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Print data and meta info.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">info_node</span><span class="p">)</span></div>
           
<div class="viewcode-block" id="scheduler.read_data"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.read_data">[docs]</a>   <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sampling</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">transpose</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">updown</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">proj_number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule an image stack reader. Often will be the first node in the queue.</span>
<span class="sd">        Args:</span>
<span class="sd">            </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">paths</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span><span class="p">,</span> <span class="n">proj_number</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">reader_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span></div>
      
<div class="viewcode-block" id="scheduler.write_data"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.write_data">[docs]</a>   <span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">compress</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule an image stack writer. </span>
<span class="sd">        Args:</span>
<span class="sd">            </span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">skip</span><span class="p">,</span> <span class="n">compress</span><span class="p">)</span>
      
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">writer_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>      </div>
   
<div class="viewcode-block" id="scheduler.display"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.display">[docs]</a>   <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display_type</span><span class="p">,</span> <span class="o">**</span><span class="n">argin</span><span class="p">):</span>

       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">display_node</span><span class="p">,</span> <span class="p">[</span><span class="n">display_type</span><span class="p">,</span> <span class="n">argin</span><span class="p">])</span>           </div>

<div class="viewcode-block" id="scheduler.derotate"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.derotate">[docs]</a>   <span class="k">def</span> <span class="nf">derotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ang</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule a to derotate the detector.</span>
<span class="sd">      </span>
<span class="sd">        Args:</span>
<span class="sd">            ang: angle to derotate with, if None - get it from geom[&#39;det_roll&#39;].</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">derotate_node</span><span class="p">,</span> <span class="n">ang</span><span class="p">)</span>       </div>

<div class="viewcode-block" id="scheduler.merge"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.merge">[docs]</a>   <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;projections&#39;</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Schedule a data merge operation. </span>
<span class="sd">        Args:</span>
<span class="sd">            mode(str): use &#39;projections&#39; or &#39;volume&#39;, depending on the type of the input.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;projections&#39;</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">proj_merge_node</span><span class="p">)</span>       
          
      <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;volume&#39;</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">vol_merge_node</span><span class="p">)</span>       
          
      <span class="k">else</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unknown mode!&#39;</span><span class="p">)</span></div>
      
<div class="viewcode-block" id="scheduler.flatlog"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.flatlog">[docs]</a>   <span class="k">def</span> <span class="nf">flatlog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usemax</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">flats</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">darks</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">sample</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">transpose</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">updown</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Read flats and darks and apply them to projection data or use &#39;usemax&#39; mode to perform a data-driven correction.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">usemax</span><span class="p">,</span> <span class="n">flats</span><span class="p">,</span> <span class="n">darks</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="n">transpose</span><span class="p">,</span> <span class="n">updown</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">flatlog_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span></div>
   
<div class="viewcode-block" id="scheduler.optimize"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.optimize">[docs]</a>   <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;axs_hrz&#39;</span><span class="p">,</span> <span class="n">tile_index</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sampling</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;highpass&#39;</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Optimize a parameter using parameter range, geometry key, tile number and sub-sampling.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">tile_index</span><span class="p">,</span> <span class="n">sampling</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">optimize_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span> </div>
       
<div class="viewcode-block" id="scheduler.registration"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.registration">[docs]</a>   <span class="k">def</span> <span class="nf">registration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subsamp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">use_moments</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
       <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">       Register volumes.</span>
<span class="sd">       &quot;&quot;&quot;</span>
       <span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span><span class="n">subsamp</span><span class="p">,</span> <span class="n">use_moments</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">registration_node</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>        </div>
    
<div class="viewcode-block" id="scheduler.report"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.report">[docs]</a>   <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Print the node tree.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
      
      <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Reporting nodes:&#39;</span><span class="p">)</span>
     
      <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
      
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">node_name</span> <span class="o">+</span> <span class="s1">&#39; : &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">state2str</span><span class="p">())</span></div>
          
<div class="viewcode-block" id="scheduler.cleanup"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.cleanup">[docs]</a>   <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Remove files after a succesfull run.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      
      <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cleaning up.&#39;</span><span class="p">)</span>
      
      <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
      
      <span class="c1"># Find ready nodes:</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodes_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">,</span> <span class="n">_NSTATE_DEACTIVATED_</span><span class="p">)</span>
      
      <span class="c1"># Cleanup nodes:</span>
      <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
          <span class="n">node</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>
      
<div class="viewcode-block" id="scheduler.run"><a class="viewcode-back" href="../../flexcalc.html#flexcalc.pipeline.scheduler.run">[docs]</a>   <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Run scheduled nodes.</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;*** Runtime ***&#39;</span><span class="p">)</span>
      
      <span class="c1"># Save a checkpoint:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
      
      <span class="c1"># Find a pending node:</span>
      <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeready_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
          
      <span class="c1"># Run nodes until they are finished:</span>
      <span class="k">while</span> <span class="n">node</span><span class="p">:</span>    
                    
          <span class="c1"># Activate next node:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39;____________________________________&#39;</span><span class="p">)</span>
          <span class="n">node</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
          
          <span class="c1"># Save a checkpoint:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
          
          <span class="c1"># Next node ready:</span>
          <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_nodeready_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_node</span><span class="p">)</span>
          
      <span class="n">logger</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;*** End Runtime ***&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Author

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>